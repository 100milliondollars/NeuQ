#!/usr/bin/env python3

from test_framework.test_framework import BitcoinTestFramework
from test_framework.util import *
from test_framework.script import *
from test_framework.mininode import *
from test_framework.address import *
from test_framework.qtum import *
import pprint
import subprocess

pp = pprint.PrettyPrinter()

class QtumEVMConstantinoplePrecompiledContractsTest(BitcoinTestFramework):
    def set_test_params(self):
        self.setup_clean_chain = True
        self.num_nodes = 1
        self.extra_args = [['-txindex=1', '-logevents=1', '-constantinopleheight=1000000']]

    def send_and_call_method(self, abi, point=False):
        print(abi)
        self.last_txid = self.node.sendtocontract(self.contract_address, abi, 0, 10000000)['txid']
        self.node.generate(1)
        if point:
            ret = self.node.callcontract(self.contract_address, "767f2a89")['executionResult']['output']
            ret += self.node.callcontract(self.contract_address, "a1461eef")['executionResult']['output']
        else:
            ret = self.node.callcontract(self.contract_address, "1b08d96f")['executionResult']['output']
        return ret

    def reset(self):
        self.node.sendtocontract(self.contract_address, 'd826f88f')
        self.node.generate(1)

    def ecrecover_test(self):
        in_val = "38d18acb67d25c8bb9942764b62f18e17054f66a817bd4295423adf9ed98873e000000000000000000000000000000000000000000000000000000000000001b38d18acb67d25c8bb9942764b62f18e17054f66a817bd4295423adf9ed98873e789d1dd423d25f0772d2748d60f7e4b81bb14d086eba8e8e8efb6dcff8a4ae02"
        out_val = "000000000000000000000000ceaccac640adf55b2028469bd36ba501f28b699d"
        abi = "7c1886d9"
        abi += in_val
        ret = self.send_and_call_method(abi)
        assert_equal(ret, out_val)

    def sha256_test(self, should_fail=False):
        for _ in range(100):
            in_val = hex_str_to_bytes(hex(random.randint(0, 2**256))[2:].zfill(64))
            abi = "12bdedd7"
            abi += "20".zfill(64)
            abi += hex(len(in_val))[2:].zfill(64)
            abi += bytes_to_hex_str(in_val) + ("00" * (32 - len(in_val)))
            ret = self.send_and_call_method(abi)
            assert_equal(ret, hashlib.new('sha256', in_val).hexdigest())

    def ripemd160_test(self, should_fail=False):
        for _ in range(100):
            in_val = hex_str_to_bytes(hex(random.randint(0, 2**256))[2:].zfill(64))
            abi = "e3c87216"
            abi += "20".zfill(64)
            abi += hex(len(in_val))[2:].zfill(64)
            abi += bytes_to_hex_str(in_val) + ("00" * (32 - len(in_val)))
            ret = self.send_and_call_method(abi)
            assert_equal(ret[0:40], hashlib.new('ripemd160', in_val).hexdigest())

    def identity_test(self, should_fail=False):
        for i in range(100):        
            in_out_val = hex(random.randint(0, 2**256))[2:].zfill(64)
            abi = "3d9c8fdb"
            abi += "20".zfill(64)
            abi += hex(len(in_out_val) // 2)[2:].zfill(64)
            abi += in_out_val
            ret = self.send_and_call_method(abi)
            assert_equal(ret, in_out_val)

    def modexp_test(self, should_fail=False):
        for _ in range(100):
            self.reset()
            base = random.randint(0, 2**256)
            e = random.randint(0, 2**256)
            m = random.randint(0, 2**256)
            abi = "fdcd12cb"
            abi += hex(base)[2:].zfill(64)
            abi += hex(e)[2:].zfill(64)
            abi += hex(m)[2:].zfill(64)
            ret = self.send_and_call_method(abi)
            if should_fail:
                assert_equal(ret, "0000000000000000000000000000000000000000000000000000000000000020")
            else:
                assert_equal(int(ret, 16), pow(base, e, m))

    def bn256add_test(self, should_fail=False):
        cases = [
            "18b18acfb4c2c30276db5411368e7185b311dd124691610c5d3b74034e093dc9063c909c4720840cb5134cb9f59fa749755796819658d32efc0d288198f3726607c2b7f58a84bd6145f00c9c2bc0bb1a187f20ff2c92963a88019e7c6a014eed06614e20c147e940f2d70da3f74c9a17df361706a4485c742bd6788478fa17d7",
            "2243525c5efd4b9c3d3c45ac0ca3fe4dd85e830a4ce6b65fa1eeaee202839703301d1d33be6da8e509df21cc35964723180eed7532537db9ae5e7d48f195c915",

            "2243525c5efd4b9c3d3c45ac0ca3fe4dd85e830a4ce6b65fa1eeaee202839703301d1d33be6da8e509df21cc35964723180eed7532537db9ae5e7d48f195c91518b18acfb4c2c30276db5411368e7185b311dd124691610c5d3b74034e093dc9063c909c4720840cb5134cb9f59fa749755796819658d32efc0d288198f37266",
            "2bd3e6d0f3b142924f5ca7b49ce5b9d54c4703d7ae5648e61d02268b1a0a9fb721611ce0a6af85915e2f1d70300909ce2e49dfad4a4619c8390cae66cefdb204",

            "0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000",
            "00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000",

            "00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000",
            "00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000",

            "0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000",
            "00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000",

            "",
            "00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000",

            "000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000",
            "00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000",

            "0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000002",
            "00000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000002",

            "000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000",
            "00000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000002",

            "00000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000002",
            "00000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000002",

            "0000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000",
            "00000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000002",

            "000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000",
            "00000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000002",

            "0000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000002",
            "030644e72e131a029b85045b68181585d97816a916871ca8d3c208c16d87cfd315ed738c0e0a7c92e7845f96b2ae9c0a68a6a449e3538fc7ff3ebf7a5a18a2c4",

            "000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000",
            "030644e72e131a029b85045b68181585d97816a916871ca8d3c208c16d87cfd315ed738c0e0a7c92e7845f96b2ae9c0a68a6a449e3538fc7ff3ebf7a5a18a2c4",

            "17c139df0efee0f766bc0204762b774362e4ded88953a39ce849a8a7fa163fa901e0559bacb160664764a357af8a9fe70baa9258e0b959273ffc5718c6d4cc7c039730ea8dff1254c0fee9c0ea777d29a9c710b7e616683f194f18c43b43b869073a5ffcc6fc7a28c30723d6e58ce577356982d65b833a5a5c15bf9024b43d98",
            "15bf2bb17880144b5d1cd2b1f46eff9d617bffd1ca57c37fb5a49bd84e53cf66049c797f9ce0d17083deb32b5e36f2ea2a212ee036598dd7624c168993d1355f",

            "17c139df0efee0f766bc0204762b774362e4ded88953a39ce849a8a7fa163fa901e0559bacb160664764a357af8a9fe70baa9258e0b959273ffc5718c6d4cc7c17c139df0efee0f766bc0204762b774362e4ded88953a39ce849a8a7fa163fa92e83f8d734803fc370eba25ed1f6b8768bd6d83887b87165fc2434fe11a830cb00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000",
            "00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000",
        ]

        i = 0
        while i < len(cases):
            print(i)
            in_val = cases[i]
            print(in_val)
            out_val = cases[i+1]
            abi = "5327e297"
            abi += in_val
            ret = self.send_and_call_method(abi, point=True)
            if should_fail:
                assert_equal(ret, in_val[0:128] if len(in_val) >= 256 else "0"*128)
            else:
                assert_equal(ret, out_val)
            i += 2

    def bn256scalarmul_test(self, should_fail=False):
        cases = [
            "2bd3e6d0f3b142924f5ca7b49ce5b9d54c4703d7ae5648e61d02268b1a0a9fb721611ce0a6af85915e2f1d70300909ce2e49dfad4a4619c8390cae66cefdb20400000000000000000000000000000000000000000000000011138ce750fa15c2",
            "070a8d6a982153cae4be29d434e8faef8a47b274a053f5a4ee2a6c9c13c31e5c031b8ce914eba3a9ffb989f9cdd5b0f01943074bf4f0f315690ec3cec6981afc",

            "070a8d6a982153cae4be29d434e8faef8a47b274a053f5a4ee2a6c9c13c31e5c031b8ce914eba3a9ffb989f9cdd5b0f01943074bf4f0f315690ec3cec6981afc30644e72e131a029b85045b68181585d97816a916871ca8d3c208c16d87cfd46",
            "025a6f4181d2b4ea8b724290ffb40156eb0adb514c688556eb79cdea0752c2bb2eff3f31dea215f1eb86023a133a996eb6300b44da664d64251d05381bb8a02e",

            "025a6f4181d2b4ea8b724290ffb40156eb0adb514c688556eb79cdea0752c2bb2eff3f31dea215f1eb86023a133a996eb6300b44da664d64251d05381bb8a02e183227397098d014dc2822db40c0ac2ecbc0b548b438e5469e10460b6c3e7ea3",
            "14789d0d4a730b354403b5fac948113739e276c23e0258d8596ee72f9cd9d3230af18a63153e0ec25ff9f2951dd3fa90ed0197bfef6e2a1a62b5095b9d2b4a27",

            "1a87b0584ce92f4593d161480614f2989035225609f08058ccfa3d0f940febe31a2f3c951f6dadcc7ee9007dff81504b0fcd6d7cf59996efdc33d92bf7f9f8f6ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff",
            "2cde5879ba6f13c0b5aa4ef627f159a3347df9722efce88a9afbb20b763b4c411aa7e43076f6aee272755a7f9b84832e71559ba0d2e0b17d5f9f01755e5b0d11",

            "1a87b0584ce92f4593d161480614f2989035225609f08058ccfa3d0f940febe31a2f3c951f6dadcc7ee9007dff81504b0fcd6d7cf59996efdc33d92bf7f9f8f630644e72e131a029b85045b68181585d2833e84879b9709143e1f593f0000000",
            "1a87b0584ce92f4593d161480614f2989035225609f08058ccfa3d0f940febe3163511ddc1c3f25d396745388200081287b3fd1472d8339d5fecb2eae0830451",

            "1a87b0584ce92f4593d161480614f2989035225609f08058ccfa3d0f940febe31a2f3c951f6dadcc7ee9007dff81504b0fcd6d7cf59996efdc33d92bf7f9f8f60000000000000000000000000000000100000000000000000000000000000000",
            "1051acb0700ec6d42a88215852d582efbaef31529b6fcbc3277b5c1b300f5cf0135b2394bb45ab04b8bd7611bd2dfe1de6a4e6e2ccea1ea1955f577cd66af85b",

            "1a87b0584ce92f4593d161480614f2989035225609f08058ccfa3d0f940febe31a2f3c951f6dadcc7ee9007dff81504b0fcd6d7cf59996efdc33d92bf7f9f8f60000000000000000000000000000000000000000000000000000000000000009",
            "1dbad7d39dbc56379f78fac1bca147dc8e66de1b9d183c7b167351bfe0aeab742cd757d51289cd8dbd0acf9e673ad67d0f0a89f912af47ed1be53664f5692575",

            "1a87b0584ce92f4593d161480614f2989035225609f08058ccfa3d0f940febe31a2f3c951f6dadcc7ee9007dff81504b0fcd6d7cf59996efdc33d92bf7f9f8f60000000000000000000000000000000000000000000000000000000000000001",
            "1a87b0584ce92f4593d161480614f2989035225609f08058ccfa3d0f940febe31a2f3c951f6dadcc7ee9007dff81504b0fcd6d7cf59996efdc33d92bf7f9f8f6",

            "17c139df0efee0f766bc0204762b774362e4ded88953a39ce849a8a7fa163fa901e0559bacb160664764a357af8a9fe70baa9258e0b959273ffc5718c6d4cc7cffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff",
            "29e587aadd7c06722aabba753017c093f70ba7eb1f1c0104ec0564e7e3e21f6022b1143f6a41008e7755c71c3d00b6b915d386de21783ef590486d8afa8453b1",

            "17c139df0efee0f766bc0204762b774362e4ded88953a39ce849a8a7fa163fa901e0559bacb160664764a357af8a9fe70baa9258e0b959273ffc5718c6d4cc7c30644e72e131a029b85045b68181585d2833e84879b9709143e1f593f0000000",
            "17c139df0efee0f766bc0204762b774362e4ded88953a39ce849a8a7fa163fa92e83f8d734803fc370eba25ed1f6b8768bd6d83887b87165fc2434fe11a830cb",

            "17c139df0efee0f766bc0204762b774362e4ded88953a39ce849a8a7fa163fa901e0559bacb160664764a357af8a9fe70baa9258e0b959273ffc5718c6d4cc7c0000000000000000000000000000000100000000000000000000000000000000",
            "221a3577763877920d0d14a91cd59b9479f83b87a653bb41f82a3f6f120cea7c2752c7f64cdd7f0e494bff7b60419f242210f2026ed2ec70f89f78a4c56a1f15",

            "17c139df0efee0f766bc0204762b774362e4ded88953a39ce849a8a7fa163fa901e0559bacb160664764a357af8a9fe70baa9258e0b959273ffc5718c6d4cc7c0000000000000000000000000000000000000000000000000000000000000009",
            "228e687a379ba154554040f8821f4e41ee2be287c201aa9c3bc02c9dd12f1e691e0fd6ee672d04cfd924ed8fdc7ba5f2d06c53c1edc30f65f2af5a5b97f0a76a",

            "17c139df0efee0f766bc0204762b774362e4ded88953a39ce849a8a7fa163fa901e0559bacb160664764a357af8a9fe70baa9258e0b959273ffc5718c6d4cc7c0000000000000000000000000000000000000000000000000000000000000001",
            "17c139df0efee0f766bc0204762b774362e4ded88953a39ce849a8a7fa163fa901e0559bacb160664764a357af8a9fe70baa9258e0b959273ffc5718c6d4cc7c",

            "039730ea8dff1254c0fee9c0ea777d29a9c710b7e616683f194f18c43b43b869073a5ffcc6fc7a28c30723d6e58ce577356982d65b833a5a5c15bf9024b43d98ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff",
            "00a1a234d08efaa2616607e31eca1980128b00b415c845ff25bba3afcb81dc00242077290ed33906aeb8e42fd98c41bcb9057ba03421af3f2d08cfc441186024",

            "039730ea8dff1254c0fee9c0ea777d29a9c710b7e616683f194f18c43b43b869073a5ffcc6fc7a28c30723d6e58ce577356982d65b833a5a5c15bf9024b43d9830644e72e131a029b85045b68181585d2833e84879b9709143e1f593f0000000",
            "039730ea8dff1254c0fee9c0ea777d29a9c710b7e616683f194f18c43b43b8692929ee761a352600f54921df9bf472e66217e7bb0cee9032e00acc86b3c8bfaf",

            "039730ea8dff1254c0fee9c0ea777d29a9c710b7e616683f194f18c43b43b869073a5ffcc6fc7a28c30723d6e58ce577356982d65b833a5a5c15bf9024b43d980000000000000000000000000000000100000000000000000000000000000000",
            "1071b63011e8c222c5a771dfa03c2e11aac9666dd097f2c620852c3951a4376a2f46fe2f73e1cf310a168d56baa5575a8319389d7bfa6b29ee2d908305791434",

            "039730ea8dff1254c0fee9c0ea777d29a9c710b7e616683f194f18c43b43b869073a5ffcc6fc7a28c30723d6e58ce577356982d65b833a5a5c15bf9024b43d980000000000000000000000000000000000000000000000000000000000000009",
            "19f75b9dd68c080a688774a6213f131e3052bd353a304a189d7a2ee367e3c2582612f545fb9fc89fde80fd81c68fc7dcb27fea5fc124eeda69433cf5c46d2d7f",

            "039730ea8dff1254c0fee9c0ea777d29a9c710b7e616683f194f18c43b43b869073a5ffcc6fc7a28c30723d6e58ce577356982d65b833a5a5c15bf9024b43d980000000000000000000000000000000000000000000000000000000000000001",
            "039730ea8dff1254c0fee9c0ea777d29a9c710b7e616683f194f18c43b43b869073a5ffcc6fc7a28c30723d6e58ce577356982d65b833a5a5c15bf9024b43d98",
        ]

        i = 0
        while i < len(cases):
            in_val = cases[i]
            out_val = cases[i+1]
            abi = "652dcd30"
            abi += in_val
            ret = self.send_and_call_method(abi, point=True)
            if should_fail:
                assert_equal(ret, in_val[0:128])
            else:
                assert_equal(ret, out_val)
            i += 2

    def bn256pairing_test(self, should_fail=False):
        cases = [
            "1c76476f4def4bb94541d57ebba1193381ffa7aa76ada664dd31c16024c43f593034dd2920f673e204fee2811c678745fc819b55d3e9d294e45c9b03a76aef41209dd15ebff5d46c4bd888e51a93cf99a7329636c63514396b4a452003a35bf704bf11ca01483bfa8b34b43561848d28905960114c8ac04049af4b6315a416782bb8324af6cfc93537a2ad1a445cfd0ca2a71acd7ac41fadbf933c2a51be344d120a2a4cf30c1bf9845f20c6fe39e07ea2cce61f0c9bb048165fe5e4de877550111e129f1cf1097710d41c4ac70fcdfa5ba2023c6ff1cbeac322de49d1b6df7c2032c61a830e3c17286de9462bf242fca2883585b93870a73853face6a6bf411198e9393920d483a7260bfb731fb5d25f1aa493335a9e71297e485b7aef312c21800deef121f1e76426a00665e5c4479674322d4f75edadd46debd5cd992f6ed090689d0585ff075ec9e99ad690c3395bc4b313370b38ef355acdadcd122975b12c85ea5db8c6deb4aab71808dcb408fe3d1e7690c43d37b4ce6cc0166fa7daa",
            "0000000000000000000000000000000000000000000000000000000000000001",
            
            "2eca0c7238bf16e83e7a1e6c5d49540685ff51380f309842a98561558019fc0203d3260361bb8451de5ff5ecd17f010ff22f5c31cdf184e9020b06fa5997db841213d2149b006137fcfb23036606f848d638d576a120ca981b5b1a5f9300b3ee2276cf730cf493cd95d64677bbb75fc42db72513a4c1e387b476d056f80aa75f21ee6226d31426322afcda621464d0611d226783262e21bb3bc86b537e986237096df1f82dff337dd5972e32a8ad43e28a78a96a823ef1cd4debe12b6552ea5f06967a1237ebfeca9aaae0d6d0bab8e28c198c5a339ef8a2407e31cdac516db922160fa257a5fd5b280642ff47b65eca77e626cb685c84fa6d3b6882a283ddd1198e9393920d483a7260bfb731fb5d25f1aa493335a9e71297e485b7aef312c21800deef121f1e76426a00665e5c4479674322d4f75edadd46debd5cd992f6ed090689d0585ff075ec9e99ad690c3395bc4b313370b38ef355acdadcd122975b12c85ea5db8c6deb4aab71808dcb408fe3d1e7690c43d37b4ce6cc0166fa7daa",
            "0000000000000000000000000000000000000000000000000000000000000001",
            
            "0f25929bcb43d5a57391564615c9e70a992b10eafa4db109709649cf48c50dd216da2f5cb6be7a0aa72c440c53c9bbdfec6c36c7d515536431b3a865468acbba2e89718ad33c8bed92e210e81d1853435399a271913a6520736a4729cf0d51eb01a9e2ffa2e92599b68e44de5bcf354fa2642bd4f26b259daa6f7ce3ed57aeb314a9a87b789a58af499b314e13c3d65bede56c07ea2d418d6874857b70763713178fb49a2d6cd347dc58973ff49613a20757d0fcc22079f9abd10c3baee245901b9e027bd5cfc2cb5db82d4dc9677ac795ec500ecd47deee3b5da006d6d049b811d7511c78158de484232fc68daf8a45cf217d1c2fae693ff5871e8752d73b21198e9393920d483a7260bfb731fb5d25f1aa493335a9e71297e485b7aef312c21800deef121f1e76426a00665e5c4479674322d4f75edadd46debd5cd992f6ed090689d0585ff075ec9e99ad690c3395bc4b313370b38ef355acdadcd122975b12c85ea5db8c6deb4aab71808dcb408fe3d1e7690c43d37b4ce6cc0166fa7daa",
            "0000000000000000000000000000000000000000000000000000000000000001",
            
            "2f2ea0b3da1e8ef11914acf8b2e1b32d99df51f5f4f206fc6b947eae860eddb6068134ddb33dc888ef446b648d72338684d678d2eb2371c61a50734d78da4b7225f83c8b6ab9de74e7da488ef02645c5a16a6652c3c71a15dc37fe3a5dcb7cb122acdedd6308e3bb230d226d16a105295f523a8a02bfc5e8bd2da135ac4c245d065bbad92e7c4e31bf3757f1fe7362a63fbfee50e7dc68da116e67d600d9bf6806d302580dc0661002994e7cd3a7f224e7ddc27802777486bf80f40e4ca3cfdb186bac5188a98c45e6016873d107f5cd131f3a3e339d0375e58bd6219347b008122ae2b09e539e152ec5364e7e2204b03d11d3caa038bfc7cd499f8176aacbee1f39e4e4afc4bc74790a4a028aff2c3d2538731fb755edefd8cb48d6ea589b5e283f150794b6736f670d6a1033f9b46c6f5204f50813eb85c8dc4b59db1c5d39140d97ee4d2b36d99bc49974d18ecca3e7ad51011956051b464d9e27d46cc25e0764bb98575bd466d32db7b15f582b2d5c452b36aa394b789366e5e3ca5aabd415794ab061441e51d01e94640b7e3084a07e02c78cf3103c542bc5b298669f211b88da1679b0b64a63b7e0e7bfe52aae524f73a55be7fe70c7e9bfc94b4cf0da1213d2149b006137fcfb23036606f848d638d576a120ca981b5b1a5f9300b3ee2276cf730cf493cd95d64677bbb75fc42db72513a4c1e387b476d056f80aa75f21ee6226d31426322afcda621464d0611d226783262e21bb3bc86b537e986237096df1f82dff337dd5972e32a8ad43e28a78a96a823ef1cd4debe12b6552ea5f",
            "0000000000000000000000000000000000000000000000000000000000000001",
            
            "20a754d2071d4d53903e3b31a7e98ad6882d58aec240ef981fdf0a9d22c5926a29c853fcea789887315916bbeb89ca37edb355b4f980c9a12a94f30deeed30211213d2149b006137fcfb23036606f848d638d576a120ca981b5b1a5f9300b3ee2276cf730cf493cd95d64677bbb75fc42db72513a4c1e387b476d056f80aa75f21ee6226d31426322afcda621464d0611d226783262e21bb3bc86b537e986237096df1f82dff337dd5972e32a8ad43e28a78a96a823ef1cd4debe12b6552ea5f1abb4a25eb9379ae96c84fff9f0540abcfc0a0d11aeda02d4f37e4baf74cb0c11073b3ff2cdbb38755f8691ea59e9606696b3ff278acfc098fa8226470d03869217cee0a9ad79a4493b5253e2e4e3a39fc2df38419f230d341f60cb064a0ac290a3d76f140db8418ba512272381446eb73958670f00cf46f1d9e64cba057b53c26f64a8ec70387a13e41430ed3ee4a7db2059cc5fc13c067194bcc0cb49a98552fd72bd9edb657346127da132e5b82ab908f5816c826acb499e22f2412d1a2d70f25929bcb43d5a57391564615c9e70a992b10eafa4db109709649cf48c50dd2198a1f162a73261f112401aa2db79c7dab1533c9935c77290a6ce3b191f2318d198e9393920d483a7260bfb731fb5d25f1aa493335a9e71297e485b7aef312c21800deef121f1e76426a00665e5c4479674322d4f75edadd46debd5cd992f6ed090689d0585ff075ec9e99ad690c3395bc4b313370b38ef355acdadcd122975b12c85ea5db8c6deb4aab71808dcb408fe3d1e7690c43d37b4ce6cc0166fa7daa",
            "0000000000000000000000000000000000000000000000000000000000000001",
        
            "1c76476f4def4bb94541d57ebba1193381ffa7aa76ada664dd31c16024c43f593034dd2920f673e204fee2811c678745fc819b55d3e9d294e45c9b03a76aef41209dd15ebff5d46c4bd888e51a93cf99a7329636c63514396b4a452003a35bf704bf11ca01483bfa8b34b43561848d28905960114c8ac04049af4b6315a416782bb8324af6cfc93537a2ad1a445cfd0ca2a71acd7ac41fadbf933c2a51be344d120a2a4cf30c1bf9845f20c6fe39e07ea2cce61f0c9bb048165fe5e4de877550111e129f1cf1097710d41c4ac70fcdfa5ba2023c6ff1cbeac322de49d1b6df7c103188585e2364128fe25c70558f1560f4f9350baf3959e603cc91486e110936198e9393920d483a7260bfb731fb5d25f1aa493335a9e71297e485b7aef312c21800deef121f1e76426a00665e5c4479674322d4f75edadd46debd5cd992f6ed090689d0585ff075ec9e99ad690c3395bc4b313370b38ef355acdadcd122975b12c85ea5db8c6deb4aab71808dcb408fe3d1e7690c43d37b4ce6cc0166fa7daa",
            "0000000000000000000000000000000000000000000000000000000000000000",
        
            "",
            "0000000000000000000000000000000000000000000000000000000000000001",
            
            "00000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000002198e9393920d483a7260bfb731fb5d25f1aa493335a9e71297e485b7aef312c21800deef121f1e76426a00665e5c4479674322d4f75edadd46debd5cd992f6ed090689d0585ff075ec9e99ad690c3395bc4b313370b38ef355acdadcd122975b12c85ea5db8c6deb4aab71808dcb408fe3d1e7690c43d37b4ce6cc0166fa7daa",
            "0000000000000000000000000000000000000000000000000000000000000000",
 
            "00000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000002198e9393920d483a7260bfb731fb5d25f1aa493335a9e71297e485b7aef312c21800deef121f1e76426a00665e5c4479674322d4f75edadd46debd5cd992f6ed090689d0585ff075ec9e99ad690c3395bc4b313370b38ef355acdadcd122975b12c85ea5db8c6deb4aab71808dcb408fe3d1e7690c43d37b4ce6cc0166fa7daa00000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000002198e9393920d483a7260bfb731fb5d25f1aa493335a9e71297e485b7aef312c21800deef121f1e76426a00665e5c4479674322d4f75edadd46debd5cd992f6ed275dc4a288d1afb3cbb1ac09187524c7db36395df7be3b99e673b13a075a65ec1d9befcd05a5323e6da4d435f3b617cdb3af83285c2df711ef39c01571827f9d",
            "0000000000000000000000000000000000000000000000000000000000000001",

            "00000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000002203e205db4f19b37b60121b83a7333706db86431c6d835849957ed8c3928ad7927dc7234fd11d3e8c36c59277c3e6f149d5cd3cfa9a62aee49f8130962b4b3b9195e8aa5b7827463722b8c153931579d3505566b4edf48d498e185f0509de15204bb53b8977e5f92a0bc372742c4830944a59b4fe6b1c0466e2a6dad122b5d2e030644e72e131a029b85045b68181585d97816a916871ca8d3c208c16d87cfd31a76dae6d3272396d0cbe61fced2bc532edac647851e3ac53ce1cc9c7e645a83198e9393920d483a7260bfb731fb5d25f1aa493335a9e71297e485b7aef312c21800deef121f1e76426a00665e5c4479674322d4f75edadd46debd5cd992f6ed090689d0585ff075ec9e99ad690c3395bc4b313370b38ef355acdadcd122975b12c85ea5db8c6deb4aab71808dcb408fe3d1e7690c43d37b4ce6cc0166fa7daa",
            "0000000000000000000000000000000000000000000000000000000000000001",

            "105456a333e6d636854f987ea7bb713dfd0ae8371a72aea313ae0c32c0bf10160cf031d41b41557f3e7e3ba0c51bebe5da8e6ecd855ec50fc87efcdeac168bcc0476be093a6d2b4bbf907172049874af11e1b6267606e00804d3ff0037ec57fd3010c68cb50161b7d1d96bb71edfec9880171954e56871abf3d93cc94d745fa114c059d74e5b6c4ec14ae5864ebe23a71781d86c29fb8fb6cce94f70d3de7a2101b33461f39d9e887dbb100f170a2345dde3c07e256d1dfa2b657ba5cd030427000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000021a2c3013d2ea92e13c800cde68ef56a294b883f6ac35d25f587c09b1b3c635f7290158a80cd3d66530f74dc94c94adb88f5cdb481acca997b6e60071f08a115f2f997f3dbd66a7afe07fe7862ce239edba9e05c5afff7f8a1259c9733b2dfbb929d1691530ca701b4a106054688728c9972c8512e9789e9567aae23e302ccd75",
            "0000000000000000000000000000000000000000000000000000000000000001",

            "00000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000002198e9393920d483a7260bfb731fb5d25f1aa493335a9e71297e485b7aef312c21800deef121f1e76426a00665e5c4479674322d4f75edadd46debd5cd992f6ed090689d0585ff075ec9e99ad690c3395bc4b313370b38ef355acdadcd122975b12c85ea5db8c6deb4aab71808dcb408fe3d1e7690c43d37b4ce6cc0166fa7daa00000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000002198e9393920d483a7260bfb731fb5d25f1aa493335a9e71297e485b7aef312c21800deef121f1e76426a00665e5c4479674322d4f75edadd46debd5cd992f6ed275dc4a288d1afb3cbb1ac09187524c7db36395df7be3b99e673b13a075a65ec1d9befcd05a5323e6da4d435f3b617cdb3af83285c2df711ef39c01571827f9d00000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000002198e9393920d483a7260bfb731fb5d25f1aa493335a9e71297e485b7aef312c21800deef121f1e76426a00665e5c4479674322d4f75edadd46debd5cd992f6ed090689d0585ff075ec9e99ad690c3395bc4b313370b38ef355acdadcd122975b12c85ea5db8c6deb4aab71808dcb408fe3d1e7690c43d37b4ce6cc0166fa7daa00000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000002198e9393920d483a7260bfb731fb5d25f1aa493335a9e71297e485b7aef312c21800deef121f1e76426a00665e5c4479674322d4f75edadd46debd5cd992f6ed275dc4a288d1afb3cbb1ac09187524c7db36395df7be3b99e673b13a075a65ec1d9befcd05a5323e6da4d435f3b617cdb3af83285c2df711ef39c01571827f9d00000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000002198e9393920d483a7260bfb731fb5d25f1aa493335a9e71297e485b7aef312c21800deef121f1e76426a00665e5c4479674322d4f75edadd46debd5cd992f6ed090689d0585ff075ec9e99ad690c3395bc4b313370b38ef355acdadcd122975b12c85ea5db8c6deb4aab71808dcb408fe3d1e7690c43d37b4ce6cc0166fa7daa00000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000002198e9393920d483a7260bfb731fb5d25f1aa493335a9e71297e485b7aef312c21800deef121f1e76426a00665e5c4479674322d4f75edadd46debd5cd992f6ed275dc4a288d1afb3cbb1ac09187524c7db36395df7be3b99e673b13a075a65ec1d9befcd05a5323e6da4d435f3b617cdb3af83285c2df711ef39c01571827f9d00000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000002198e9393920d483a7260bfb731fb5d25f1aa493335a9e71297e485b7aef312c21800deef121f1e76426a00665e5c4479674322d4f75edadd46debd5cd992f6ed090689d0585ff075ec9e99ad690c3395bc4b313370b38ef355acdadcd122975b12c85ea5db8c6deb4aab71808dcb408fe3d1e7690c43d37b4ce6cc0166fa7daa00000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000002198e9393920d483a7260bfb731fb5d25f1aa493335a9e71297e485b7aef312c21800deef121f1e76426a00665e5c4479674322d4f75edadd46debd5cd992f6ed275dc4a288d1afb3cbb1ac09187524c7db36395df7be3b99e673b13a075a65ec1d9befcd05a5323e6da4d435f3b617cdb3af83285c2df711ef39c01571827f9d00000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000002198e9393920d483a7260bfb731fb5d25f1aa493335a9e71297e485b7aef312c21800deef121f1e76426a00665e5c4479674322d4f75edadd46debd5cd992f6ed090689d0585ff075ec9e99ad690c3395bc4b313370b38ef355acdadcd122975b12c85ea5db8c6deb4aab71808dcb408fe3d1e7690c43d37b4ce6cc0166fa7daa00000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000002198e9393920d483a7260bfb731fb5d25f1aa493335a9e71297e485b7aef312c21800deef121f1e76426a00665e5c4479674322d4f75edadd46debd5cd992f6ed275dc4a288d1afb3cbb1ac09187524c7db36395df7be3b99e673b13a075a65ec1d9befcd05a5323e6da4d435f3b617cdb3af83285c2df711ef39c01571827f9d",
            "0000000000000000000000000000000000000000000000000000000000000001",
 
            "00000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000002203e205db4f19b37b60121b83a7333706db86431c6d835849957ed8c3928ad7927dc7234fd11d3e8c36c59277c3e6f149d5cd3cfa9a62aee49f8130962b4b3b9195e8aa5b7827463722b8c153931579d3505566b4edf48d498e185f0509de15204bb53b8977e5f92a0bc372742c4830944a59b4fe6b1c0466e2a6dad122b5d2e030644e72e131a029b85045b68181585d97816a916871ca8d3c208c16d87cfd31a76dae6d3272396d0cbe61fced2bc532edac647851e3ac53ce1cc9c7e645a83198e9393920d483a7260bfb731fb5d25f1aa493335a9e71297e485b7aef312c21800deef121f1e76426a00665e5c4479674322d4f75edadd46debd5cd992f6ed090689d0585ff075ec9e99ad690c3395bc4b313370b38ef355acdadcd122975b12c85ea5db8c6deb4aab71808dcb408fe3d1e7690c43d37b4ce6cc0166fa7daa00000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000002203e205db4f19b37b60121b83a7333706db86431c6d835849957ed8c3928ad7927dc7234fd11d3e8c36c59277c3e6f149d5cd3cfa9a62aee49f8130962b4b3b9195e8aa5b7827463722b8c153931579d3505566b4edf48d498e185f0509de15204bb53b8977e5f92a0bc372742c4830944a59b4fe6b1c0466e2a6dad122b5d2e030644e72e131a029b85045b68181585d97816a916871ca8d3c208c16d87cfd31a76dae6d3272396d0cbe61fced2bc532edac647851e3ac53ce1cc9c7e645a83198e9393920d483a7260bfb731fb5d25f1aa493335a9e71297e485b7aef312c21800deef121f1e76426a00665e5c4479674322d4f75edadd46debd5cd992f6ed090689d0585ff075ec9e99ad690c3395bc4b313370b38ef355acdadcd122975b12c85ea5db8c6deb4aab71808dcb408fe3d1e7690c43d37b4ce6cc0166fa7daa00000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000002203e205db4f19b37b60121b83a7333706db86431c6d835849957ed8c3928ad7927dc7234fd11d3e8c36c59277c3e6f149d5cd3cfa9a62aee49f8130962b4b3b9195e8aa5b7827463722b8c153931579d3505566b4edf48d498e185f0509de15204bb53b8977e5f92a0bc372742c4830944a59b4fe6b1c0466e2a6dad122b5d2e030644e72e131a029b85045b68181585d97816a916871ca8d3c208c16d87cfd31a76dae6d3272396d0cbe61fced2bc532edac647851e3ac53ce1cc9c7e645a83198e9393920d483a7260bfb731fb5d25f1aa493335a9e71297e485b7aef312c21800deef121f1e76426a00665e5c4479674322d4f75edadd46debd5cd992f6ed090689d0585ff075ec9e99ad690c3395bc4b313370b38ef355acdadcd122975b12c85ea5db8c6deb4aab71808dcb408fe3d1e7690c43d37b4ce6cc0166fa7daa00000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000002203e205db4f19b37b60121b83a7333706db86431c6d835849957ed8c3928ad7927dc7234fd11d3e8c36c59277c3e6f149d5cd3cfa9a62aee49f8130962b4b3b9195e8aa5b7827463722b8c153931579d3505566b4edf48d498e185f0509de15204bb53b8977e5f92a0bc372742c4830944a59b4fe6b1c0466e2a6dad122b5d2e030644e72e131a029b85045b68181585d97816a916871ca8d3c208c16d87cfd31a76dae6d3272396d0cbe61fced2bc532edac647851e3ac53ce1cc9c7e645a83198e9393920d483a7260bfb731fb5d25f1aa493335a9e71297e485b7aef312c21800deef121f1e76426a00665e5c4479674322d4f75edadd46debd5cd992f6ed090689d0585ff075ec9e99ad690c3395bc4b313370b38ef355acdadcd122975b12c85ea5db8c6deb4aab71808dcb408fe3d1e7690c43d37b4ce6cc0166fa7daa00000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000002203e205db4f19b37b60121b83a7333706db86431c6d835849957ed8c3928ad7927dc7234fd11d3e8c36c59277c3e6f149d5cd3cfa9a62aee49f8130962b4b3b9195e8aa5b7827463722b8c153931579d3505566b4edf48d498e185f0509de15204bb53b8977e5f92a0bc372742c4830944a59b4fe6b1c0466e2a6dad122b5d2e030644e72e131a029b85045b68181585d97816a916871ca8d3c208c16d87cfd31a76dae6d3272396d0cbe61fced2bc532edac647851e3ac53ce1cc9c7e645a83198e9393920d483a7260bfb731fb5d25f1aa493335a9e71297e485b7aef312c21800deef121f1e76426a00665e5c4479674322d4f75edadd46debd5cd992f6ed090689d0585ff075ec9e99ad690c3395bc4b313370b38ef355acdadcd122975b12c85ea5db8c6deb4aab71808dcb408fe3d1e7690c43d37b4ce6cc0166fa7daa",
            "0000000000000000000000000000000000000000000000000000000000000001",
            
            "105456a333e6d636854f987ea7bb713dfd0ae8371a72aea313ae0c32c0bf10160cf031d41b41557f3e7e3ba0c51bebe5da8e6ecd855ec50fc87efcdeac168bcc0476be093a6d2b4bbf907172049874af11e1b6267606e00804d3ff0037ec57fd3010c68cb50161b7d1d96bb71edfec9880171954e56871abf3d93cc94d745fa114c059d74e5b6c4ec14ae5864ebe23a71781d86c29fb8fb6cce94f70d3de7a2101b33461f39d9e887dbb100f170a2345dde3c07e256d1dfa2b657ba5cd030427000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000021a2c3013d2ea92e13c800cde68ef56a294b883f6ac35d25f587c09b1b3c635f7290158a80cd3d66530f74dc94c94adb88f5cdb481acca997b6e60071f08a115f2f997f3dbd66a7afe07fe7862ce239edba9e05c5afff7f8a1259c9733b2dfbb929d1691530ca701b4a106054688728c9972c8512e9789e9567aae23e302ccd75",
            "0000000000000000000000000000000000000000000000000000000000000001"
        ]
        
        i = 0
        while i < len(cases):
            print(i)
            in_val = cases[i]
            out_val = cases[i+1]
            abi = "1a0ffebe"
            abi += "20".zfill(64)
            abi += hex(len(in_val) // 2)[2:].zfill(64)
            abi += in_val
            ret = self.send_and_call_method(abi)
            if should_fail:
                assert_equal(ret, "0"*64)
            else:
                assert_equal(ret, out_val)
            i += 2

    def run_test(self):
        self.nodes[0].generate(COINBASE_MATURITY+50)
        self.node = self.nodes[0]
        """
        pragma solidity ^0.5;

        contract PrecompilesTest {
            uint256 public ret;
            uint256 public pointX;
            uint256 public pointY;

            function reset() public {
                ret = 0xffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff;
                pointX = 0xffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff;
                pointY = 0xffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff;
            }

            function ecrecover_test(bytes32 h, uint8 v, bytes32 r, bytes32 s) public {
                ret = uint256(ecrecover(h, v, r, s));
            }

            function sha256_test(bytes memory data) public {
                ret = uint256(sha256(data));
            }

            function ripemd160_test(bytes memory data) public {
                ret = uint256(bytes32(ripemd160(data)));
            }

            function identity_test(bytes memory data) public {
                uint256 o;
                uint256 size = data.length;
                assembly {
                    let p := mload(0x40)
                    let success := call(sub(gas, 2000), 0x04, 0, add(data, 0x20), size, p, size)
                    switch success case 0 {
                        o := 0xffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff
                    } default {
                        o := mload(p)
                    }
                }
                ret = o;
            }

            function expmod_test(uint256 base, uint256 e, uint256 m) public {
                uint256 o;
                assembly {
                    let p := mload(0x40)
                    mstore(p, 0x20)
                    mstore(add(p, 0x20), 0x20)
                    mstore(add(p, 0x40), 0x20)
                    mstore(add(p, 0x60), base)
                    mstore(add(p, 0x80), e)
                    mstore(add(p, 0xa0), m)
                    let success := call(sub(gas, 2000), 0x05, 0, p, 0xc0, p, 0x20)
                    switch success case 0 {
                        o := 0xffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff
                    } default {
                        o := mload(p)
                    }
                }
                ret = o;
            }

            function bn256add_test(uint256[2] memory pointA, uint256[2] memory pointB) public {
                uint256 localX;
                uint256 localY;
                uint256 size = 0x80;
                assembly {
                    let p := mload(0x40)
                    mstore(add(p, 0x0), mload(pointA))
                    mstore(add(p, 0x20), mload(add(pointA, 0x20)))
                    mstore(add(p, 0x40), mload(pointB))
                    mstore(add(p, 0x60), mload(add(pointB, 0x20)))
                    let success := call(sub(gas, 2000), 0x06, 0, p, size, p, 0x40)
                    switch success case 0 {
                        localX := 0xffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff
                        localY := 0xffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff
                    } default {
                        localX := mload(p)
                        localY := mload(add(p, 0x20))
                    }
                }
                pointX = localX;
                pointY = localY;
            }

            function bn256scalarmul_test(uint256[2] memory point, uint256 scalar) public {
                uint256 localX;
                uint256 localY;
                uint256 size = 0x60;
                assembly {
                    let p := mload(0x40)
                    mstore(add(p, 0x0), mload(point))
                    mstore(add(p, 0x20), mload(add(point, 0x20)))
                    mstore(add(p, 0x40), scalar)
                    let success := call(sub(gas, 2000), 0x07, 0, p, size, p, 0x40)
                    switch success case 0 {
                        localX := 0xffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff
                        localY := 0xffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff
                    } default {
                        localX := mload(p)
                        localY := mload(add(p, 0x20))
                    }
                }
                pointX = localX;
                pointY = localY;
            }

            function bn256pairing_test(bytes memory points) public {
                uint256 o;
                uint256 size = points.length;
                assembly {
                    let p := mload(0x40)
                    let success := call(sub(gas, 2000), 0x08, 0, add(points, 0x20), size, p, 0x20)
                    switch success case 0 {
                        o := 0xffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff
                    } default {
                        o := mload(p)
                    }
                }
                ret = o;
            }
        }

        5327e297: bn256add_test(uint256[2],uint256[2])
        1a0ffebe: bn256pairing_test(bytes)
        652dcd30: bn256scalarmul_test(uint256[2],uint256)
        7c1886d9: ecrecover_test(bytes32,uint8,bytes32,bytes32)
        fdcd12cb: expmod_test(uint256,uint256,uint256)
        3d9c8fdb: identity_test(bytes)
        767f2a89: pointX()
        a1461eef: pointY()
        d826f88f: reset()
        1b08d96f: ret()
        e3c87216: ripemd160_test(bytes)
        12bdedd7: sha256_test(bytes)
        """
        bytecode = "608060405234801561001057600080fd5b50610b1b806100206000396000f3fe608060405234801561001057600080fd5b50600436106100d1576000357c010000000000000000000000000000000000000000000000000000000090048063767f2a891161008e578063767f2a891461043a5780637c1886d914610458578063a1461eef146104a7578063d826f88f146104c5578063e3c87216146104cf578063fdcd12cb1461058a576100d1565b806312bdedd7146100d65780631a0ffebe146101915780631b08d96f1461024c5780633d9c8fdb1461026a5780635327e29714610325578063652dcd30146103cb575b600080fd5b61018f600480360360208110156100ec57600080fd5b810190808035906020019064010000000081111561010957600080fd5b82018360208201111561011b57600080fd5b8035906020019184600183028401116401000000008311171561013d57600080fd5b91908080601f016020809104026020016040519081016040528093929190818152602001838380828437600081840152601f19601f8201169050808301925050505050505091929192905050506105cc565b005b61024a600480360360208110156101a757600080fd5b81019080803590602001906401000000008111156101c457600080fd5b8201836020820111156101d657600080fd5b803590602001918460018302840111640100000000831117156101f857600080fd5b91908080601f016020809104026020016040519081016040528093929190818152602001838380828437600081840152601f19601f820116905080830192505050505050509192919290505050610681565b005b6102546106e2565b6040518082815260200191505060405180910390f35b6103236004803603602081101561028057600080fd5b810190808035906020019064010000000081111561029d57600080fd5b8201836020820111156102af57600080fd5b803590602001918460018302840111640100000000831117156102d157600080fd5b91908080601f016020809104026020016040519081016040528093929190818152602001838380828437600081840152601f19601f8201169050808301925050505050505091929192905050506106e8565b005b6103c96004803603608081101561033b57600080fd5b8101908080604001906002806020026040519081016040528092919082600260200280828437600081840152601f19601f820116905080830192505050505050919291929080604001906002806020026040519081016040528092919082600260200280828437600081840152601f19601f8201169050808301925050505050509192919290505050610748565b005b610438600480360360608110156103e157600080fd5b8101908080604001906002806020026040519081016040528092919082600260200280828437600081840152601f19601f8201169050808301925050505050509192919290803590602001909291905050506107fd565b005b6104426108a7565b6040518082815260200191505060405180910390f35b6104a56004803603608081101561046e57600080fd5b8101908080359060200190929190803560ff16906020019092919080359060200190929190803590602001909291905050506108ad565b005b6104af610940565b6040518082815260200191505060405180910390f35b6104cd610946565b005b610588600480360360208110156104e557600080fd5b810190808035906020019064010000000081111561050257600080fd5b82018360208201111561051457600080fd5b8035906020019184600183028401116401000000008311171561053657600080fd5b91908080601f016020809104026020016040519081016040528093929190818152602001838380828437600081840152601f19601f8201169050808301925050505050505091929192905050506109bd565b005b6105ca600480360360608110156105a057600080fd5b81019080803590602001909291908035906020019092919080359060200190929190505050610a71565b005b6002816000604051602001526040518082805190602001908083835b6020831061060b57805182526020820191506020810190506020830392506105e8565b6001836020036101000a0380198251168184511680821785525050505050509050019150506020604051808303816000866161da5a03f115801561064e57600080fd5b50505060405160208081101561066357600080fd5b81019080805190602001909291905050506001900460008190555050565b600080825190506040516020818360208701600060086107d05a03f180600081146106af57825194506106d3565b7fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff94505b50505081600081905550505050565b60005481565b6000808251905060405181818360208701600060046107d05a03f180600081146107155782519450610739565b7fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff94505b50505081600081905550505050565b600080600060809050604051855160008201526020860151602082015284516040820152602085015160608201526040818383600060066107d05a03f1806000811461079e5782519550602083015194506107e5565b7fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff95507fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff94505b50505082600181905550816002819055505050505050565b60008060006060905060405185516000820152602086015160208201528460408201526040818383600060076107d05a03f1806000811461084857825195506020830151945061088f565b7fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff95507fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff94505b50505082600181905550816002819055505050505050565b60015481565b60018484848460405160008152602001604052600060405160200152604051808581526020018460ff1660ff16815260200183815260200182815260200194505050505060206040516020810390808403906000866161da5a03f115801561091457600080fd5b5050506020604051035173ffffffffffffffffffffffffffffffffffffffff1660008190555050505050565b60025481565b7fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff6000819055507fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff6001819055507fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff600281905550565b6003816000604051602001526040518082805190602001908083835b602083106109fc57805182526020820191506020810190506020830392506109d9565b6001836020036101000a0380198251168184511680821785525050505050509050019150506020604051808303816000866161da5a03f1158015610a3f57600080fd5b505050604051516c01000000000000000000000000026bffffffffffffffffffffffff19166001900460008190555050565b600060405160208152602080820152602060408201528460608201528360808201528260a082015260208160c083600060056107d05a03f18060008114610abb5782519350610adf565b7fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff93505b505050806000819055505050505056fea165627a7a72305820ad8768556058f9bede07b7a64f41702df9de711a94e0312cf4d9b715fd6e05100029"
        self.contract_address = self.node.createcontract(bytecode)['address']
        self.node.generate(1)
        
        # Test without qip7 (constantinople precompiles).
        self.reset()
        self.ecrecover_test()

        self.reset()
        self.sha256_test()

        self.reset()
        self.ripemd160_test()

        self.reset()
        self.identity_test()

        self.reset()
        self.modexp_test(should_fail=True)
        
        self.reset()
        self.bn256add_test(should_fail=True)

        self.reset()
        self.bn256scalarmul_test(should_fail=True)

        self.reset()
        self.bn256pairing_test(should_fail=True)


        # Now test with qip7 (constantinople precompiles) activated.
        # All the old precompiles should still work, as well as the new contracts
        self.restart_node(0, ['-constantinopleheight=1106'])
        bytecode = "608060405234801561001057600080fd5b50610ad2806100206000396000f3fe608060405234801561001057600080fd5b50600436106100b45760003560e01c8063767f2a8911610071578063767f2a891461041d5780637c1886d91461043b578063a1461eef1461048a578063d826f88f146104a8578063e3c87216146104b2578063fdcd12cb1461056d576100b4565b806312bdedd7146100b95780631a0ffebe146101745780631b08d96f1461022f5780633d9c8fdb1461024d5780635327e29714610308578063652dcd30146103ae575b600080fd5b610172600480360360208110156100cf57600080fd5b81019080803590602001906401000000008111156100ec57600080fd5b8201836020820111156100fe57600080fd5b8035906020019184600183028401116401000000008311171561012057600080fd5b91908080601f016020809104026020016040519081016040528093929190818152602001838380828437600081840152601f19601f8201169050808301925050505050505091929192905050506105af565b005b61022d6004803603602081101561018a57600080fd5b81019080803590602001906401000000008111156101a757600080fd5b8201836020820111156101b957600080fd5b803590602001918460018302840111640100000000831117156101db57600080fd5b91908080601f016020809104026020016040519081016040528093929190818152602001838380828437600081840152601f19601f820116905080830192505050505050509192919290505050610659565b005b6102376106ba565b6040518082815260200191505060405180910390f35b6103066004803603602081101561026357600080fd5b810190808035906020019064010000000081111561028057600080fd5b82018360208201111561029257600080fd5b803590602001918460018302840111640100000000831117156102b457600080fd5b91908080601f016020809104026020016040519081016040528093929190818152602001838380828437600081840152601f19601f8201169050808301925050505050505091929192905050506106c0565b005b6103ac6004803603608081101561031e57600080fd5b8101908080604001906002806020026040519081016040528092919082600260200280828437600081840152601f19601f820116905080830192505050505050919291929080604001906002806020026040519081016040528092919082600260200280828437600081840152601f19601f8201169050808301925050505050509192919290505050610720565b005b61041b600480360360608110156103c457600080fd5b8101908080604001906002806020026040519081016040528092919082600260200280828437600081840152601f19601f8201169050808301925050505050509192919290803590602001909291905050506107d5565b005b61042561087f565b6040518082815260200191505060405180910390f35b6104886004803603608081101561045157600080fd5b8101908080359060200190929190803560ff1690602001909291908035906020019092919080359060200190929190505050610885565b005b61049261090e565b6040518082815260200191505060405180910390f35b6104b0610914565b005b61056b600480360360208110156104c857600080fd5b81019080803590602001906401000000008111156104e557600080fd5b8201836020820111156104f757600080fd5b8035906020019184600183028401116401000000008311171561051957600080fd5b91908080601f016020809104026020016040519081016040528093929190818152602001838380828437600081840152601f19601f82011690508083019250505050505050919291929050505061098b565b005b6105ad6004803603606081101561058357600080fd5b81019080803590602001909291908035906020019092919080359060200190929190505050610a28565b005b6002816040518082805190602001908083835b602083106105e557805182526020820191506020810190506020830392506105c2565b6001836020036101000a038019825116818451168082178552505050505050905001915050602060405180830381855afa158015610627573d6000803e3d6000fd5b5050506040513d602081101561063c57600080fd5b810190808051906020019092919050505060001c60008190555050565b600080825190506040516020818360208701600060086107d05a03f1806000811461068757825194506106ab565b7fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff94505b50505081600081905550505050565b60005481565b6000808251905060405181818360208701600060046107d05a03f180600081146106ed5782519450610711565b7fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff94505b50505081600081905550505050565b600080600060809050604051855160008201526020860151602082015284516040820152602085015160608201526040818383600060066107d05a03f180600081146107765782519550602083015194506107bd565b7fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff95507fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff94505b50505082600181905550816002819055505050505050565b60008060006060905060405185516000820152602086015160208201528460408201526040818383600060076107d05a03f18060008114610820578251955060208301519450610867565b7fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff95507fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff94505b50505082600181905550816002819055505050505050565b60015481565b60018484848460405160008152602001604052604051808581526020018460ff1660ff1681526020018381526020018281526020019450505050506020604051602081039080840390855afa1580156108e2573d6000803e3d6000fd5b5050506020604051035173ffffffffffffffffffffffffffffffffffffffff1660008190555050505050565b60025481565b7fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff6000819055507fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff6001819055507fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff600281905550565b6003816040518082805190602001908083835b602083106109c1578051825260208201915060208101905060208303925061099e565b6001836020036101000a038019825116818451168082178552505050505050905001915050602060405180830381855afa158015610a03573d6000803e3d6000fd5b5050506040515160601b6bffffffffffffffffffffffff191660001c60008190555050565b600060405160208152602080820152602060408201528460608201528360808201528260a082015260208160c083600060056107d05a03f18060008114610a725782519350610a96565b7fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff93505b505050806000819055505050505056fea165627a7a7230582067f822d1339f29c535c6013b09d2374c1f589e39e98a74012a3519186ee9b2630029"
        self.contract_address = self.node.createcontract(bytecode)['address']
        self.node.generate(1)

        self.reset()
        self.ecrecover_test()

        self.reset()
        self.sha256_test()

        self.reset()
        self.ripemd160_test()

        self.reset()
        self.identity_test()

        self.reset()
        self.modexp_test(should_fail=False)
        
        self.reset()
        self.bn256add_test(should_fail=False)

        self.reset()
        self.bn256scalarmul_test(should_fail=False)

        self.reset()
        self.bn256pairing_test(should_fail=False)

if __name__ == '__main__':
    QtumEVMConstantinoplePrecompiledContractsTest().main()
